"use strict";(globalThis.webpackChunkisraelrodirguez_2_docusaurus=globalThis.webpackChunkisraelrodirguez_2_docusaurus||[]).push([[618],{3214(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/image-20240203141253-chw0tv0-c6d269c6d2fa3a499d0192368401dbe2.png"},7907(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"documentacion_it/miscelanea/kerberos","title":"\ud83d\udcc4 Configuraci\xf3n de SSH + kerberos","description":"2023-02-01","source":"@site/docs/documentacion_it/miscelanea/kerberos.md","sourceDirName":"documentacion_it/miscelanea","slug":"/documentacion_it/miscelanea/kerberos","permalink":"/documentacion_it/miscelanea/kerberos","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"\ud83d\udcc4 Configuraci\xf3n de SSH + kerberos"},"sidebar":"tutorialSidebar","previous":{"title":"\ud83d\udcc1 Miscelanea","permalink":"/documentacion_it/miscelanea/"},"next":{"title":"\ud83d\udcc4 LPI 102 - Apuntes examen","permalink":"/documentacion_it/miscelanea/lpic_102_exam"}}');var i=s(4848),t=s(8453);const o={title:"\ud83d\udcc4 Configuraci\xf3n de SSH + kerberos"},d="Configuraci\xf3n de SSH + kerberos",a={},c=[{value:"Definici\xf3n y objetivos",id:"definici\xf3n-y-objetivos",level:2},{value:"Networking",id:"networking",level:3},{value:"Esquema de la arquitectura",id:"esquema-de-la-arquitectura",level:3},{value:"Configuraci\xf3n",id:"configuraci\xf3n",level:2},{value:"Configuracion krserver",id:"configuracion-krserver",level:3},{value:"Configurar los clientes de KERBEROS (KHOST1 KHOST2)",id:"configurar-los-clientes-de-kerberos-khost1-khost2",level:3},{value:"Configurar servidor ssh (KHOST2)",id:"configurar-servidor-ssh-khost2",level:3},{value:"Configurar cliente ssh (KHOST1)",id:"configurar-cliente-ssh-khost1",level:3}];function l(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"configuraci\xf3n-de-ssh--kerberos",children:"Configuraci\xf3n de SSH + kerberos"})}),"\n",(0,i.jsx)("span",{class:"badge badge--primary",children:"2023-02-01"}),"\n",(0,i.jsx)(n.h2,{id:"definici\xf3n-y-objetivos",children:"Definici\xf3n y objetivos"}),"\n",(0,i.jsx)(n.p,{children:"Esta documentaci\xf3n se centra en el despliegue de un servidor Kerberos en un entorno de red y su integraci\xf3n con SSH."}),"\n",(0,i.jsx)(n.h3,{id:"networking",children:"Networking"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"megatron.local"}),(0,i.jsx)(n.th,{children:"INTERFACE1"}),(0,i.jsx)(n.th,{children:"IP management"}),(0,i.jsx)(n.th,{children:"INTERFACE2"}),(0,i.jsx)(n.th,{children:"IP2 service"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"kserver"}),(0,i.jsx)(n.td,{children:"ens18"}),(0,i.jsx)(n.td,{children:"192.168.4.201/24"}),(0,i.jsx)(n.td,{children:"ens19"}),(0,i.jsx)(n.td,{children:"10.0.8.10/24"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"khost1"}),(0,i.jsxs)(n.td,{children:["ens18",(0,i.jsx)("br",{})]}),(0,i.jsx)(n.td,{children:"192.168.4.202/24"}),(0,i.jsxs)(n.td,{children:["ens19",(0,i.jsx)("br",{})]}),(0,i.jsx)(n.td,{children:"10.0.8.50/24"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"khost2"}),(0,i.jsxs)(n.td,{children:["ens18",(0,i.jsx)("br",{})]}),(0,i.jsxs)(n.td,{children:["192.168.4.203/24",(0,i.jsx)("br",{})]}),(0,i.jsxs)(n.td,{children:["ens19",(0,i.jsx)("br",{})]}),(0,i.jsx)(n.td,{children:"10.0.8.51/24"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"esquema-de-la-arquitectura",children:"Esquema de la arquitectura"}),"\n",(0,i.jsxs)(n.p,{children:["\u200b",(0,i.jsx)(n.img,{alt:"image",src:s(3214).A+"",width:"1192",height:"692"}),"\u200b"]}),"\n",(0,i.jsx)(n.h2,{id:"configuraci\xf3n",children:"Configuraci\xf3n"}),"\n",(0,i.jsx)(n.h3,{id:"configuracion-krserver",children:"Configuracion krserver"}),"\n",(0,i.jsx)(n.p,{children:"Insertar registros DNS de forma manual en /etc/hosts"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"127.0.0.1       localhost\n127.0.1.1       kserver.megatron.local  kserver\n\n# KERBEROS\n10.0.8.10       kserver.megatron.local\n10.0.8.50       khost1.megatron.local\n10.0.8.51       khost2.megatron.local\n"})}),"\n",(0,i.jsx)(n.p,{children:"Instalar paquetes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"apt install krb5-kdc krb5-admin-server\n"})}),"\n",(0,i.jsx)(n.p,{children:"Configurar datos de entrada para el servidor del reino y el dominio del servidor"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Reino: MEGATRON.LOCAL\nSer. Kerberos: krserver.megatron.local\nServ. Admin Kerberos: krserver.megatron.local\n"})}),"\n",(0,i.jsx)(n.p,{children:"Desactivar Ks4 /etc/default/krb5-kdc. A\xf1adir"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"KRB4_MODE=disable\nRUN_KRB524D=false\n"})}),"\n",(0,i.jsx)(n.p,{children:"A\xf1dir en /etc/krb5.conf. El resto de realms configurados por defecto se pueden borrar"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[domain_realm]\n        .megatron.local = MEGATRON.LOCAL\n        megatron.local = MEGATRON.LOCAL\n"})}),"\n",(0,i.jsx)(n.p,{children:"Definir nuevo realm y reiniciar servicios. Importante agregar contrase\xf1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"krb5_newrealm\nsystemctl start krb5-admin-server\nsystemctl start krb5-kdc\n"})}),"\n",(0,i.jsx)(n.p,{children:"Acceder a la consola de kerberos. Nos pide contrase\xf1a root realm"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kadmin.local\n"})}),"\n",(0,i.jsx)(n.p,{children:"Crear usuario y agregarlo como administrador. Nos pide contrase\xf1a para el usuario"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kadmin.local: add_principal israel@MEGATRON.LOCAL\nkadmin.local: add_principal israel/admin@MEGATRON.LOCAL\n"})}),"\n",(0,i.jsx)(n.p,{children:"Habilitamos usuarios administradores descomentado la linea en /etc/krb5kdc/kadm5.acl"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"*/admin *\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configurar-los-clientes-de-kerberos-khost1-khost2",children:"Configurar los clientes de KERBEROS (KHOST1 KHOST2)"}),"\n",(0,i.jsx)(n.p,{children:"Al no configurar DNS metemos registros a mano.  /etc/hosts"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"127.0.0.1       localhost\n127.0.1.1       khost2.megatron.local   khost2\n\n# KERBEROS\n10.0.8.10       kserver.megatron.local\n10.0.8.50       khost1.megatron.local\n10.0.8.51       khost2.megatron.local\n"})}),"\n",(0,i.jsx)(n.p,{children:"Instalar paquetes y configurar"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"apt-get install krb5-user krb5-config\n\n    Reino: MEGATRON.LOCAL\n    Ser. Kerberos: krserver.megatron.local\n    Serv. Admin Kerberos: krserver.megatron.local\n"})}),"\n",(0,i.jsx)(n.p,{children:"A\xf1dir en /etc/krb5.conf. El resto de realms configurados por defecto se pueden borrar"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[domain_realm]\n        .megatron.local = MEGATRON.LOCAL\n        megatron.local = MEGATRON.LOCAL\n"})}),"\n",(0,i.jsx)(n.p,{children:"Compobamos que obtenemo ticket de krserver. Nos pide contrase\xf1a de usuarios"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"x@khost2:~$ kinit israel\nPassword for israel@MEGATRON.LOCAL:\nx@khost2:~$ klist\nTicket cache: FILE:/tmp/krb5cc_1000\nDefault principal: israel@MEGATRON.LOCAL\n\nValid starting       Expires              Service principal\n10/28/2022 15:02:08  10/29/2022 01:02:08  krbtgt/MEGATRON.LOCAL@MEGATRON.LOCAL\n        renew until 10/29/2022 15:01:39\nx@khost2:~$\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configurar-servidor-ssh-khost2",children:"Configurar servidor ssh (KHOST2)"}),"\n",(0,i.jsx)(n.p,{children:"En el servidor krserver generamos y exportamos las claves del servidor ssh khost2"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kadmin.local\nkadmin.local: add_principal -randkey host/khost2.megatron.local@MEGATRON.LOCAL\nkadmin.local: ktadd host/israel.megatron.local\nkadmin.local: ktadd -k /tmp/khost2.keytab host/khost2.megatron.local@MEGATRON.LOCAL\n"})}),"\n",(0,i.jsx)(n.p,{children:"Le eviamos la clave generada a khost2"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"scp /tmp/khost2.keytab x@khost2.megatron.local:/home/x\n"})}),"\n",(0,i.jsx)(n.p,{children:"En el servidor ssh khost2 movemos las claves a /etc y damos permisos"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"chmod 400 /etc/khost2.keytab\nchown sshd:ssh /etc/khost2.keytab\n"})}),"\n",(0,i.jsx)(n.p,{children:"Activar en /etc/ssh/sshd_config"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"# GSSAPI options\nGSSAPIAuthentication yes\nGSSAPICleanupCredentials yes\n"})}),"\n",(0,i.jsx)(n.p,{children:"Reiniciar daemon ssd"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"systemctl restart sshd\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configurar-cliente-ssh-khost1",children:"Configurar cliente ssh (KHOST1)"}),"\n",(0,i.jsx)(n.p,{children:"Editar /etc/ssh/ssh_config"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GSSAPIAuthentication yes\nGSSAPIDelegateCredentials yes\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"systemctl restart ssh\n"})}),"\n",(0,i.jsx)(n.p,{children:"Obtener ticket con el usuario"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"x@khost2:~$ kinit israel\nPassword for israel@MEGATRON.LOCAL:\nx@khost2:~$ klist\nTicket cache: FILE:/tmp/krb5cc_1000\nDefault principal: israel@MEGATRON.LOCAL\n\nValid starting       Expires              Service principal\n10/28/2022 15:02:08  10/29/2022 01:02:08  krbtgt/MEGATRON.LOCAL@MEGATRON.LOCAL\n        renew until 10/29/2022 15:01:39\nx@khost2:~$\n"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Ya nos podemos loggear al el servidor ssh (khost2) desde khost1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"x@khost1:~$ ssh -v israel@khost2.megatron.local\nOpenSSH_8.4p1 Debian-5+deb11u1, OpenSSL 1.1.1n  15 Mar 2022\ndebug1: Reading configuration data /etc/ssh/ssh_config\ndebug1: /etc/ssh/ssh_config line 19: include /etc/ssh/ssh_config.d/*.conf matched no files\ndebug1: /etc/ssh/ssh_config line 21: Applying options for *\ndebug1: Connecting to khost2.megatron.local [10.0.8.51] port 22.\ndebug1: Connection established.\ndebug1: identity file /home/x/.ssh/id_rsa type -1\ndebug1: identity file /home/x/.ssh/id_rsa-cert type -1\ndebug1: identity file /home/x/.ssh/id_dsa type -1\ndebug1: identity file /home/x/.ssh/id_dsa-cert type -1\ndebug1: identity file /home/x/.ssh/id_ecdsa type -1\ndebug1: identity file /home/x/.ssh/id_ecdsa-cert type -1\ndebug1: identity file /home/x/.ssh/id_ecdsa_sk type -1\ndebug1: identity file /home/x/.ssh/id_ecdsa_sk-cert type -1\ndebug1: identity file /home/x/.ssh/id_ed25519 type -1\ndebug1: identity file /home/x/.ssh/id_ed25519-cert type -1\ndebug1: identity file /home/x/.ssh/id_ed25519_sk type -1\ndebug1: identity file /home/x/.ssh/id_ed25519_sk-cert type -1\ndebug1: identity file /home/x/.ssh/id_xmss type -1\ndebug1: identity file /home/x/.ssh/id_xmss-cert type -1\ndebug1: Local version string SSH-2.0-OpenSSH_8.4p1 Debian-5+deb11u1\ndebug1: Remote protocol version 2.0, remote software version OpenSSH_8.4p1 Debian-5+deb11u1\ndebug1: match: OpenSSH_8.4p1 Debian-5+deb11u1 pat OpenSSH* compat 0x04000000\ndebug1: Authenticating to khost2.megatron.local:22 as 'israel'\ndebug1: SSH2_MSG_KEXINIT sent\ndebug1: SSH2_MSG_KEXINIT received\ndebug1: kex: algorithm: curve25519-sha256\ndebug1: kex: host key algorithm: ecdsa-sha2-nistp256\ndebug1: kex: server->client cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none\ndebug1: kex: client->server cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none\ndebug1: expecting SSH2_MSG_KEX_ECDH_REPLY\ndebug1: Server host key: ecdsa-sha2-nistp256 SHA256:V51lOSp6fLZlsISKdQFImQh7J31r+Pyt1aya+Kdrs3Y\ndebug1: Host 'khost2.megatron.local' is known and matches the ECDSA host key.\ndebug1: Found key in /home/x/.ssh/known_hosts:1\ndebug1: rekey out after 134217728 blocks\ndebug1: SSH2_MSG_NEWKEYS sent\ndebug1: expecting SSH2_MSG_NEWKEYS\ndebug1: SSH2_MSG_NEWKEYS received\ndebug1: rekey in after 134217728 blocks\ndebug1: Will attempt key: /home/x/.ssh/id_rsa\ndebug1: Will attempt key: /home/x/.ssh/id_dsa\ndebug1: Will attempt key: /home/x/.ssh/id_ecdsa\ndebug1: Will attempt key: /home/x/.ssh/id_ecdsa_sk\ndebug1: Will attempt key: /home/x/.ssh/id_ed25519\ndebug1: Will attempt key: /home/x/.ssh/id_ed25519_sk\ndebug1: Will attempt key: /home/x/.ssh/id_xmss\ndebug1: SSH2_MSG_EXT_INFO received\ndebug1: kex_input_ext_info: server-sig-algs=<ssh-ed25519,sk-ssh-ed25519@openssh.com,ssh-rsa,rsa-sha2-256,rsa-sha2-512,ssh-dss,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,sk-ecdsa-sha2-nistp256@openssh.com,webauthn-sk-ecdsa-sha2-nistp256@openssh.com>\ndebug1: SSH2_MSG_SERVICE_ACCEPT received\ndebug1: Authentications that can continue: publickey,gssapi-keyex,gssapi-with-mic,password\ndebug1: Next authentication method: gssapi-with-mic\ndebug1: Delegating credentials\ndebug1: Delegating credentials\ndebug1: Authentication succeeded (gssapi-with-mic).\nAuthenticated to khost2.megatron.local ([10.0.8.51]:22).\ndebug1: channel 0: new [client-session]\ndebug1: Requesting no-more-sessions@openssh.com\ndebug1: Entering interactive session.\ndebug1: pledge: network\ndebug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0\ndebug1: Sending environment.\ndebug1: Sending env LANG = en_US.UTF-8\nLinux khost2 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64\n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nWeb console: https://khost2.megatron.local:9090/ or https://192.168.4.203:9090/\n\nLast login: Fri Oct 28 14:09:35 2022 from 10.0.8.50\nisrael@khost2:~$\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>d});var r=s(6540);const i={},t=r.createContext(i);function o(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);